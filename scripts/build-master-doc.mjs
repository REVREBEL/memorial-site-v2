// scripts/build-master-doc.mjs
import { promises as fs } from "fs";
import path from "path";

const ROOT = process.cwd();
const OUTPUT_FILE = "MASTER_GUIDE.md";

// Order the important ones explicitly; everything else will be appended.
const ORDERED_FILES = [
  "README.md",
  "QUICK_START.md",
  "PRE_DEPLOYMENT_CHECKLIST.md",
  "IMAGE_COMPRESSION_GUIDE.md",
  "COMPLETE_FILE_LIST.md",
  "CLOUDFLARE_CONFIG.md",
  "D1_SETUP_GUIDE.md",
  "R2_SETUP_GUIDE.md",
  "DATABASE_SETUP.md",
  "EMBEDDING_GUIDE.md",
  "WEBFLOW_DEPLOYMENT.md",
  "GITHUB_DEPLOYMENT.md",
  "DEPLOYMENT_STEPS.md",
  "DEPLOYMENT_NOTES.md",
  "import-code-components-to-webflow.md",
  "MIGRATION_GUIDE.md",
  "DEPLOYMENT_FIX.md",
  "DEPLOYMENT_ISSUE_RESOLVED.md",
  "DATABASE_FIX_SUMMARY.md",
  "CHAT_MEMORY.md",
];

function toNiceTitle(filename) {
  const base = filename.replace(/\.md$/i, "");
  return base
    .replace(/_/g, " ")
    .replace(/-/g, " ")
    .replace(/\s+/g, " ")
    .replace(/\b\w/g, (c) => c.toUpperCase());
}

function normalizeContent(content) {
  // Trim leading/trailing whitespace
  let out = content.trim();

  // If it starts with a top-level "# ..." heading, strip just that first line
  const lines = out.split(/\r?\n/);
  if (lines[0].startsWith("# ")) {
    lines.shift();
    out = lines.join("\n").trim();
  }

  return out;
}

async function main() {
  const dirEntries = await fs.readdir(ROOT, { withFileTypes: true });
  const allMd = dirEntries
    .filter((d) => d.isFile() && d.name.toLowerCase().endsWith(".md"))
    .map((d) => d.name)
    .filter((name) => name !== OUTPUT_FILE);

  // Files in explicit order first, then any others that exist but weren’t listed
  const ordered = [
    ...ORDERED_FILES.filter((f) => allMd.includes(f)),
    ...allMd.filter((f) => !ORDERED_FILES.includes(f)),
  ];

  let combined = "# Memorial Site v2 – Master Guide\n\n";
  combined +=
    "> This document is auto-generated by `scripts/build-master-doc.mjs` by combining all Markdown files in the repo.\n\n";

  for (const filename of ordered) {
    const filePath = path.join(ROOT, filename);
    const raw = await fs.readFile(filePath, "utf8");
    const body = normalizeContent(raw);
    const title = toNiceTitle(filename);

    combined += `\n---\n\n`;
    combined += `## ${title}\n\n`;
    combined += `<!-- Source: ${filename} -->\n\n`;
    combined += body + "\n";
  }

  await fs.writeFile(path.join(ROOT, OUTPUT_FILE), combined, "utf8");
  console.log(`✅ Wrote ${OUTPUT_FILE} with ${ordered.length} sections.`);
}

main().catch((err) => {
  console.error("❌ Error building master doc:", err);
  process.exit(1);
});
