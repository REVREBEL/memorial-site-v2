# Patricia Lanning Memorial Site - Master Guide

> **Environment:** Webflow Cloud with Cloudflare Workers (D1 + R2)  
> **Last Updated:** December 6, 2025  
> **Status:** âœ… Production Ready

---

## ğŸš€ Quick Start

### For Webflow Cloud (Production)
No setup needed! Push to GitHub and Webflow Cloud handles everything:
- Automatic builds
- Automatic database migrations
- Automatic D1 & R2 provisioning

### For Local Development (Optional)
```bash
# 1. Install dependencies
npm install

# 2. Apply database migrations locally
npm run db:apply:local

# 3. Start dev server
npm run dev

# 4. Open http://localhost:3000
```

---

## ğŸ“‹ Project Overview

A memorial website for Patricia Lanning featuring:
- **Memory Wall** - Share memories with photos/videos
- **Guestbook** - Leave messages and condolences
- **Stories Section** - Featured memories display
- **Media Management** - Cloudflare R2 storage for photos/videos

### Tech Stack
- **Frontend:** Astro 5.13.5 + React 19
- **Styling:** Tailwind CSS 4 + Webflow Design System
- **Database:** Cloudflare D1 (SQLite)
- **Storage:** Cloudflare R2
- **ORM:** Drizzle ORM 0.44.7
- **Deployment:** Webflow Cloud â†’ Cloudflare Workers

---

## ğŸ“ Project Structure

```
memory-journal/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pages/                      # Astro pages (file-based routing)
â”‚   â”‚   â”œâ”€â”€ index.astro            # Home - Memory Wall
â”‚   â”‚   â”œâ”€â”€ guestbook.astro        # Guestbook page
â”‚   â”‚   â”œâ”€â”€ timeline.astro         # Timeline view
â”‚   â”‚   â”œâ”€â”€ recipes.astro          # Recipes (coming soon)
â”‚   â”‚   â””â”€â”€ api/                   # API endpoints
â”‚   â”‚       â”œâ”€â”€ memory_journal/    # Memory CRUD operations
â”‚   â”‚       â”œâ”€â”€ guestbook/         # Guestbook operations
â”‚   â”‚       â”œâ”€â”€ media/[...key].ts  # R2 media serving
â”‚   â”‚       â””â”€â”€ upload.ts          # Media upload handling
â”‚   â”œâ”€â”€ components/                 # React components
â”‚   â”‚   â”œâ”€â”€ MemoryWall.tsx         # Main memory display
â”‚   â”‚   â”œâ”€â”€ MemoryForm.tsx         # Memory submission form
â”‚   â”‚   â”œâ”€â”€ GuestBookWrapper.tsx   # Guestbook with pagination
â”‚   â”‚   â”œâ”€â”€ NavigationWrapper.tsx  # Site navigation
â”‚   â”‚   â”œâ”€â”€ FooterWrapper.tsx      # Site footer
â”‚   â”‚   â””â”€â”€ ui/                    # shadcn components
â”‚   â”œâ”€â”€ site-components/            # Webflow DevLink components
â”‚   â”‚   â”œâ”€â”€ MemoryCard.jsx         # Memory display cards
â”‚   â”‚   â”œâ”€â”€ GuestbookCard.jsx      # Guestbook entry cards
â”‚   â”‚   â”œâ”€â”€ Navigation.jsx         # Navigation component
â”‚   â”‚   â”œâ”€â”€ Footer.jsx             # Footer component
â”‚   â”‚   â””â”€â”€ global.css             # Webflow design tokens
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ schema/index.ts        # Database schema (Drizzle)
â”‚   â”‚   â””â”€â”€ getDb.ts               # DB connection helper
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ base-url.ts            # Base path helper (critical!)
â”‚   â”œâ”€â”€ layouts/
â”‚   â”‚   â””â”€â”€ main.astro             # Main page layout
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ global.css             # Global styles & overrides
â”œâ”€â”€ migrations/                     # Database migrations (auto-applied)
â”‚   â”œâ”€â”€ 0000_initial.sql
â”‚   â”œâ”€â”€ 0001_fix_nullable_fields.sql
â”‚   â”œâ”€â”€ 0002_fix_guestbook_fields.sql
â”‚   â””â”€â”€ 0003_recreate_likes_table.sql
â”œâ”€â”€ generated/                      # Auto-generated by Webflow
â”‚   â”œâ”€â”€ fonts.css
â”‚   â””â”€â”€ webflow.css                # Design tokens
â”œâ”€â”€ wrangler.jsonc                  # Cloudflare Workers config
â”œâ”€â”€ astro.config.mjs                # Astro configuration
â”œâ”€â”€ drizzle.config.ts               # Drizzle Kit config
â””â”€â”€ package.json
```

---

## ğŸ—„ï¸ Database Schema

### memories table
Stores user-submitted memories with optional media.

```sql
CREATE TABLE memories (
  id              TEXT PRIMARY KEY,        -- e.g., "mem_1234567890_abc123"
  headline        TEXT NOT NULL,
  name            TEXT NOT NULL,
  email           TEXT,                    -- Optional
  memory          TEXT NOT NULL,
  memory_date     TEXT,                    -- Optional (YYYY-MM format)
  location        TEXT,                    -- Optional
  tags            TEXT DEFAULT '[]',       -- JSON array
  media_key       TEXT,                    -- R2 storage key
  media_type      TEXT DEFAULT 'none',     -- 'photo' | 'video' | 'none'
  created_at      TEXT NOT NULL
);
```

### likes table
Tracks likes on memories.

```sql
CREATE TABLE likes (
  id              INTEGER PRIMARY KEY AUTOINCREMENT,
  memory_id       TEXT NOT NULL,
  created_at      TEXT NOT NULL,
  FOREIGN KEY (memory_id) REFERENCES memories(id) ON DELETE CASCADE
);
```

### guestbook table
Stores guestbook entries.

```sql
CREATE TABLE guestbook (
  id              TEXT PRIMARY KEY,        -- e.g., "gb_1234567890_xyz789"
  name            TEXT NOT NULL,
  email           TEXT,                    -- Optional
  location        TEXT,                    -- Optional
  relationship    TEXT,                    -- Optional
  first_met       TEXT,                    -- Optional
  message         TEXT NOT NULL,
  created_at      TEXT NOT NULL
);
```

### Performance Indexes
```sql
CREATE INDEX idx_memories_created_at ON memories(created_at DESC);
CREATE INDEX idx_likes_memory_id ON likes(memory_id);
CREATE INDEX idx_guestbook_created_at ON guestbook(created_at DESC);
```

---

## ğŸ”Œ API Endpoints

### Memory Journal
```typescript
GET  /api/memory_journal           // List all memories
POST /api/memory_journal           // Create new memory (with FormData)
POST /api/memory_journal/:id/like  // Toggle like
```

### Guestbook
```typescript
GET  /api/guestbook                // List entries (paginated)
POST /api/guestbook                // Add entry (JSON)
```

### Media
```typescript
GET  /api/media/:key               // Serve photo/video from R2
POST /api/upload                   // Upload media to R2 (internal)
```

### Health Check
```typescript
GET  /health-check                 // Verify DB connection
```

---

## ğŸ¨ Webflow DevLink Components

### Memory Components
- **MemoryCard** - 1x1, 2x3, 3x2 variants with 5 color options
- **MemoryJournalCardSlots** - Masonry grid layout
- **MemoryJournalFilterTags** - Tag filtering UI
- **MemoryJournalHeading** - Section headers

### Guestbook Components
- **GuestbookCard** - Entry cards with 6 color variants
- **GuestbookForm** - Entry submission form
- **GuestbookMainHeading** - Page header
- **GuestbookFilterTag** - Relationship filters
- **FilterPreviousNextSlots** - Pagination controls

### Navigation & Layout
- **Navigation** - Site navigation with Webflow styling
- **Footer** - Site footer
- **Button** variants - Primary, Secondary, Outline styles

### DevLink Integration
All Webflow components are in `src/site-components/` and must be wrapped with:
```tsx
import { DevLinkProvider } from '../site-components/DevLinkProvider';

<DevLinkProvider>
  {/* Your Webflow components */}
</DevLinkProvider>
```

**Important:** Import `src/site-components/global.css` for styling!

---

## âš™ï¸ Configuration Files

### astro.config.mjs
```javascript
import { defineConfig } from 'astro/config';
import cloudflare from '@astrojs/cloudflare';
import react from '@astrojs/react';

export default defineConfig({
  output: 'server',
  adapter: cloudflare({
    platformProxy: {
      enabled: true,  // Enables D1/R2 in local dev
    },
  }),
  server: {
    port: 3000,
  },
  integrations: [react()],
  security: {
    checkOrigin: false,  // Required for FormData submissions
  },
  // Base path set via BASE_URL env var in Webflow Cloud
  base: import.meta.env.BASE_URL || '/',
});
```

### wrangler.jsonc
```jsonc
{
  "name": "memory-journal",
  "compatibility_date": "2025-04-15",
  "compatibility_flags": ["nodejs_compat"],
  "d1_databases": [{
    "binding": "DB",
    "database_name": "memory-wall-db",
    "database_id": "ef51dd7c-c700-4fb0-a3fd-29193928ad4e",
    "migrations_dir": "migrations"  // Auto-applied in production
  }],
  "r2_buckets": [{
    "binding": "MEDIA_BUCKET",
    "bucket_name": "memory-wall-media"
  }]
}
```

### worker-configuration.d.ts
```typescript
interface Env {
  DB: D1Database;
  MEDIA_BUCKET: R2Bucket;
  WEBFLOW_CMS_SITE_API_TOKEN?: string;
  WEBFLOW_API_HOST?: string;
}
```

---

## ğŸš¢ Deployment

### Webflow Cloud (Production)

**Automatic Deployment:**
1. Push to GitHub
2. Webflow Cloud automatically:
   - Runs `npm ci && npm run build`
   - Applies migrations from `migrations/`
   - Provisions D1 database & R2 bucket
   - Deploys to Cloudflare Workers

**Environment Variables (Set in Webflow Dashboard):**
- `BASE_URL` - Provided automatically (e.g., `/memory-journal`)
- `ASSETS_PREFIX` - Provided automatically
- Custom vars (if needed):
  - `WEBFLOW_CMS_SITE_API_TOKEN`
  - `WEBFLOW_API_HOST`

### Local Development

```bash
# 1. Install dependencies
npm install

# 2. Apply migrations to local D1
npm run db:apply:local

# 3. Start dev server (with platform proxy)
npm run dev

# 4. Preview production build locally
npm run preview  # Uses wrangler dev
```

**Key Difference:**
- **Local:** Database in `.wrangler/state/v3/d1/`
- **Production:** Real Cloudflare D1 database

---

## ğŸ› ï¸ NPM Scripts

```json
{
  "dev": "astro dev",                    // Start dev server (port 3000)
  "build": "astro build",                // Production build
  "preview": "astro build && wrangler dev",  // Preview with Wrangler
  "db:generate": "drizzle-kit generate", // Generate migration from schema
  "db:apply:local": "wrangler d1 migrations apply DB --local",
  "cleanup": "rm -rf /tmp/* /var/tmp/* ..."  // Disk cleanup
}
```

---

## ğŸ”‘ Critical Implementation Details

### 1. Base URL Handling (CRITICAL!)

**NEVER hardcode paths.** Always use `baseUrl`:

```typescript
// src/lib/base-url.ts
export const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');

// Usage in components:
import { baseUrl } from '../lib/base-url';

fetch(`${baseUrl}/api/memory_journal`);  // âœ… CORRECT
fetch('/api/memory_journal');             // âŒ WRONG - breaks in production
```

**Why:** Webflow Cloud mounts apps at paths like `/memory-journal`, not root.

### 2. Database Access Pattern

**Server-side ONLY** - NEVER in client components:

```typescript
// âœ… GOOD - API route or .astro file
import { getDb } from '../../../db/getDb';

export const GET: APIRoute = async ({ locals }) => {
  const db = getDb(locals);  // â† Pass locals
  const memories = await db.select().from(memoriesTable);
  return Response.json(memories);
};

// âŒ BAD - Client component
// Never import getDb in .tsx files with client:only
import { getDb } from '...';  // â† Will break!
```

### 3. Media URL Construction

```typescript
// Store only the key in database
media_key: "photos/1234567890-image.jpg"

// Construct full URL in frontend
const photoUrl = memory.mediaKey 
  ? `${baseUrl}/api/media/${memory.mediaKey}`
  : undefined;
```

### 4. React Component Client Directives

```astro
<!-- Server-render first, then hydrate -->
<Navigation client:load />

<!-- Client-only (uses browser APIs) -->
<MemoryWall client:only="react" />
```

### 5. Cloudflare Workers Compatibility

**Use Uint8Array instead of Buffer:**
```typescript
// âŒ BAD - Buffer doesn't exist in Workers
const bytes = Buffer.from(base64, 'base64');

// âœ… GOOD - Use atob + Uint8Array
const binaryString = atob(base64);
const bytes = new Uint8Array(binaryString.length);
for (let i = 0; i < binaryString.length; i++) {
  bytes[i] = binaryString.charCodeAt(i);
}
```

---

## ğŸ¯ Features & Functionality

### Memory Wall
- âœ… Grid layout with masonry positioning
- âœ… Photo/video upload with R2 storage
- âœ… Automatic image compression (< 1MB)
- âœ… Tag filtering
- âœ… Like functionality
- âœ… Memory detail dialog
- âœ… Responsive 3-column form layout
- âœ… Color variants for cards without photos

### Guestbook
- âœ… Form with name, message, relationship, location
- âœ… Message rendering with proper display
- âœ… Pagination (10 entries per page)
- âœ… Filter by relationship type
- âœ… Date formatting (Month YYYY)
- âœ… Card color rotation (6 variants)

### Media Management
- âœ… R2 cloud storage
- âœ… Automatic image compression (browser-image-compression)
- âœ… File size limits: 1.5MB images, 10MB videos
- âœ… Supported formats: JPEG, PNG, GIF, WebP, MP4, WebM
- âœ… CDN caching (1 year cache headers)
- âœ… Placeholder image for missing media

### Navigation
- âœ… Home (`/`)
- âœ… Timeline (`/timeline`)
- âœ… Recipes (`/recipes`)
- âœ… Guestbook (`/guestbook`)
- âœ… Proper page-based routing (no hash fragments)

---

## âš ï¸ Known Issues & Limitations

### Current Constraints
1. **Pagination:** Loads all memories at once (may slow with 100+ entries)
2. **Real-time Updates:** Manual refresh needed to see others' memories
3. **Image Optimization:** No lazy loading or responsive images yet
4. **Video:** Tested but less optimized than images

### Performance Considerations
- Consider implementing:
  - Virtual scrolling for large lists
  - Image lazy loading
  - Pagination or infinite scroll
  - WebP format for better compression

---

## ğŸ› Troubleshooting

### "No such table: memories"
**Fix:** Run migrations locally
```bash
npm run db:apply:local
```

### Photos not displaying
**Check:**
1. R2 bucket binding configured in `wrangler.jsonc`
2. Media URL constructed with `baseUrl`
3. File uploaded successfully (check R2 bucket)
4. Browser console for fetch errors

### Guestbook messages missing
**Cause:** Component prop `messageMessageText` not passed

**Fix:** Already fixed in `GuestBookWrapper.tsx`:
```typescript
messageVisibility={!!entry.message}
messageMessageText={entry.message || ''}
```

### Pagination buttons not working
**Cause:** Wrong slot prop names

**Fix:** Already fixed - use `previousPreviousSlot` and `nextNextSlot`

### Media endpoint returns 500
**Cause:** Using `Buffer.from()` in Cloudflare Workers

**Fix:** Already fixed - use `atob()` + `Uint8Array`

### Type errors with locals
**Check:** `worker-configuration.d.ts` includes:
```typescript
interface Env {
  DB: D1Database;
  MEDIA_BUCKET: R2Bucket;
}
```

---

## ğŸ“š Migration Workflow

### When Modifying Schema

1. **Edit schema:** `src/db/schema/index.ts`
2. **Generate migration:**
   ```bash
   npm run db:generate
   ```
   Creates file in `drizzle/` directory

3. **Move to migrations:**
   ```bash
   mv drizzle/0001_*.sql migrations/
   ```

4. **Apply locally:**
   ```bash
   npm run db:apply:local
   ```

5. **Test changes:**
   ```bash
   npm run dev
   ```

6. **Deploy:** Push to GitHub
   - Migrations **auto-apply** in production

### Migration Files
- `0000_initial.sql` - Initial schema
- `0001_fix_nullable_fields.sql` - Fixed nullable email/tags
- `0002_fix_guestbook_fields.sql` - Fixed nullable guestbook fields
- `0003_recreate_likes_table.sql` - Proper likes table structure

**Important:** Drizzle generates to `drizzle/`, but Cloudflare reads from `migrations/`

---

## ğŸ¨ Styling & Design

### Webflow Design System
- Fonts: Bodoni Moda (headings), Aileron (body/buttons)
- Primary color: #C98769 (warm clay)
- Background: #F5F1EB (soft sand)
- Foreground: #29708d (blue-teal)
- Secondary: #E6DCD4 (light clay)

### CSS Variables (from generated/webflow.css)
```css
:root {
  --_apps---colors--primary: #C98769;
  --_apps---colors--background: #F5F1EB;
  --_apps---colors--foreground: #29708d;
  --_apps---typography--heading-font: 'Bodoni Moda', sans-serif;
  --_apps---typography--body-font: Aileron, Arial, sans-serif;
  --_apps---sizes--radius: 0.5rem;
}
```

### Critical CSS Overrides (in src/styles/global.css)
```css
/* Fix Webflow's .grid class breaking form layout */
.grid {
  grid-auto-columns: auto !important;
  grid-auto-rows: auto !important;
}

/* Force wide dialog for memory form */
.memory-form-dialog {
  width: 95vw !important;
  max-width: 1400px !important;
}

/* Ensure dialog appears above all content */
[data-slot="dialog-overlay"] {
  z-index: 999998 !important;
}

[data-slot="dialog-content"] {
  z-index: 999999 !important;
}
```

---

## ğŸ“ Recent Fixes Applied (Dec 6, 2025)

### Critical Bug Fixes
1. âœ… **Pagination buttons** - Fixed prop names for `FilterPreviousNextSlots`
2. âœ… **"All Posts" filter** - Now shows visual active state
3. âœ… **Buffer usage** - Fixed for Cloudflare Workers compatibility
4. âœ… **Guestbook messages** - Now display correctly

### Details in CRITICAL_FIXES_APPLIED.md

---

## âœ… Production Checklist

Before deploying:

- [x] Database schema matches migrations
- [x] All migrations in `migrations/` directory
- [x] `wrangler.jsonc` has correct DB & R2 bindings
- [x] All URLs use `baseUrl` constant
- [x] React components have proper `client:` directives
- [x] No `Buffer` usage (use `Uint8Array`)
- [x] No database imports in client components
- [x] TypeScript builds without errors
- [x] Local build succeeds: `npm run build`

After deploying:

- [ ] Visit app URL
- [ ] Test memory submission with photo
- [ ] Test like functionality
- [ ] Test guestbook entry
- [ ] Test tag filtering
- [ ] Test pagination
- [ ] Check media display
- [ ] Verify mobile responsive

---

## ğŸ†˜ Support & Documentation

### Key Documentation Files
- `CRITICAL_FIXES_APPLIED.md` - Latest bug fixes (Dec 6, 2025)
- `DATABASE_SETUP.md` - Database configuration
- `R2_SETUP_GUIDE.md` - Media storage setup
- `IMAGE_COMPRESSION_GUIDE.md` - Compression details
- `DEPLOYMENT_READY.md` - Deployment verification

### External Resources
- [Webflow Cloud Docs](https://developers.webflow.com/cloud)
- [Astro Cloudflare Adapter](https://docs.astro.build/en/guides/integrations-guide/cloudflare/)
- [Cloudflare D1 Docs](https://developers.cloudflare.com/d1/)
- [Cloudflare R2 Docs](https://developers.cloudflare.com/r2/)
- [Drizzle ORM Docs](https://orm.drizzle.team/)

---

## ğŸ“ Key Lessons & Best Practices

### 1. Always Use Base URL
Never hardcode paths - use `baseUrl` from `src/lib/base-url.ts`

### 2. Server-Side Database Access Only
Never import database helpers in client components

### 3. FormData for File Uploads
Use FormData when uploading files, not JSON

### 4. Cloudflare Workers Compatibility
No Node.js globals - use Web APIs (`atob`, `Uint8Array`)

### 5. Migrations Auto-Apply in Production
Don't manually run migrations in Webflow Cloud

### 6. DevLink Components Need Provider
Wrap Webflow components with `<DevLinkProvider>`

### 7. Import Site Component CSS
Always import `src/site-components/global.css`

---

## ğŸ“Š Success Metrics

### Functionality âœ…
- All memories display correctly
- Photos upload and display
- Tag filtering works
- Pagination functional
- Likes increment properly
- Guestbook displays messages

### User Experience âœ…
- Responsive on all devices
- Fast load times
- Clear visual feedback
- Intuitive navigation
- Proper error handling

### Code Quality âœ…
- Type-safe with TypeScript
- Comprehensive error handling
- Clean data flow
- Maintainable structure
- Well-documented

---

**Status:** âœ… Production Ready  
**Last Deployment:** December 6, 2025  
**Environment:** Webflow Cloud â†’ Cloudflare Workers  
**Database:** ef51dd7c-c700-4fb0-a3fd-29193928ad4e

---

*Made with â¤ï¸ for Patricia Lanning*
